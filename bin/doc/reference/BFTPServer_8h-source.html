<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>BFTPServer.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>BFTPServer.h</h1><div class="fragment"><pre>00001 <span class="comment">// BFTPServer.h (this is -*- C++ -*-)</span>
00002 <span class="comment">// </span>
00003 <span class="comment">// \author: Bjoern Giesler &lt;bjoern@giesler.de&gt;</span>
00004 <span class="comment">// </span>
00005 <span class="comment">// \mainpage</span>
00006 <span class="comment">// </span>
00007 <span class="comment">// $Author: giesler $</span>
00008 <span class="comment">// $Locker$</span>
00009 <span class="comment">// $Revision$</span>
00010 <span class="comment">// $Date: 2002-08-19 10:41:28 +0200 (Mon, 19 Aug 2002) $</span>
00011 
00113 <span class="preprocessor">#ifndef BFTPSERVER_H</span>
00114 <span class="preprocessor"></span><span class="preprocessor">#define BFTPSERVER_H</span>
00115 <span class="preprocessor"></span>
00116 <span class="comment">/* system includes */</span>
00117 <span class="preprocessor">#include &lt;deque&gt;</span>
00118 <span class="preprocessor">#include &lt;netinet/in.h&gt;</span>
00119 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00120 <span class="preprocessor">#include &lt;fat.h&gt;</span>
00121 <span class="preprocessor">#include &lt;DSGUI/BVirtualFile.h&gt;</span>
00122 
00123 <span class="comment">/* my includes */</span>
00124 <span class="preprocessor">#include "<a class="code" href="BTCPConnection_8h.html">BTCPConnection.h</a>"</span>
00125 
00126 <span class="keyword">class </span><a class="code" href="classBFTPControlConn.html">BFTPControlConn</a>;
00127 
<a name="l00129"></a><a class="code" href="structBFTPUser.html">00129</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00131"></a><a class="code" href="structBFTPUser.html#m0">00131</a>   std::string name;
00132 
<a name="l00134"></a><a class="code" href="structBFTPUser.html#m1">00134</a>   std::string pass;
00135 
<a name="l00137"></a><a class="code" href="structBFTPUser.html#m2">00137</a>   std::string root;
00138 
<a name="l00140"></a><a class="code" href="structBFTPUser.html#m3">00140</a>   std::string home;
00141 
<a name="l00143"></a><a class="code" href="structBFTPUser.html#m4">00143</a>   <span class="keywordtype">bool</span> writePermission;
00144 
<a name="l00146"></a><a class="code" href="structBFTPUser.html#m5">00146</a>   <span class="keywordtype">bool</span> bootPermission;
00147 
<a name="l00149"></a><a class="code" href="structBFTPUser.html#m6">00149</a>   <span class="keywordtype">bool</span> loggedIn;
00150 } <a class="code" href="structBFTPUser.html">BFTPUser</a>;
00151 
<a name="l00159"></a><a class="code" href="classBFTPServer.html">00159</a> <span class="keyword">class </span><a class="code" href="classBFTPServer.html">BFTPServer</a>: <span class="keyword">public</span> <a class="code" href="classBTCPConnection.html">BTCPConnection</a> {
00160 <span class="keyword">public</span>:
00161 
00169   <a class="code" href="classBFTPServer.html#a0">BFTPServer</a>();
00170 
00172   <a class="code" href="classBFTPServer.html#a0">BFTPServer</a>(<span class="keywordtype">short</span> port);
00173   ~<a class="code" href="classBFTPServer.html">BFTPServer</a>();
00174 
00176   <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classBFTPServer.html#a3">handle</a>();
00177 
<a name="l00179"></a><a class="code" href="classBFTPServer.html#a4">00179</a>   <span class="keywordtype">int</span> <a class="code" href="classBFTPServer.html#a4">numActiveConnections</a>() { <span class="keywordflow">return</span> connections.size(); }
00180 
00186 
00187   <span class="keywordtype">void</span> <a class="code" href="classBFTPServer.html#z0_0">addUser</a>(<span class="keyword">const</span> std::string&amp; name,
00188                <span class="keyword">const</span> std::string&amp; pass,
00189                <span class="keyword">const</span> std::string&amp; home = <span class="stringliteral">"/"</span>,
00190                <span class="keyword">const</span> std::string&amp; root = <span class="stringliteral">"/"</span>,
00191                <span class="keywordtype">bool</span> writePermission = <span class="keyword">true</span>,
00192                <span class="keywordtype">bool</span> bootPermission = <span class="keyword">true</span>);
00193 
00195   <span class="keywordtype">bool</span> <a class="code" href="classBFTPServer.html#z0_1">anonymousLoginOK</a>();
00196 
00198   <span class="keywordtype">void</span> <a class="code" href="classBFTPServer.html#z0_2">setMOTDFile</a>(<span class="keyword">const</span> std::string&amp; motdFile);
<a name="l00200"></a><a class="code" href="classBFTPServer.html#z0_3">00200</a>   <span class="keyword">const</span> std::string&amp; <a class="code" href="classBFTPServer.html#z0_3">getMOTDFile</a>() { <span class="keywordflow">return</span> motdFile; }
00201 
00210   <span class="keywordtype">void</span> <a class="code" href="classBFTPServer.html#z0_4">setMasqueradeAsHost</a>(<span class="keyword">const</span> std::string&amp; host);
<a name="l00212"></a><a class="code" href="classBFTPServer.html#z0_5">00212</a>   <span class="keyword">const</span> std::string&amp; <a class="code" href="classBFTPServer.html#z0_5">getMasqueradeAsHost</a>() { <span class="keywordflow">return</span> masqueradeAsHost; }
00213 
00220   <span class="keywordtype">void</span> <a class="code" href="classBFTPServer.html#z0_6">setInactivityTimeout</a>(<span class="keywordtype">int</span> timeout);
<a name="l00222"></a><a class="code" href="classBFTPServer.html#z0_7">00222</a>   <span class="keywordtype">int</span> <a class="code" href="classBFTPServer.html#z0_7">getInactivityTimeout</a>() { <span class="keywordflow">return</span> inactivityTimeout; }
00223 
00225   <span class="keywordtype">void</span> <a class="code" href="classBFTPServer.html#z0_8">setPortRangeStart</a>(<span class="keywordtype">int</span> portRangeStart);
<a name="l00227"></a><a class="code" href="classBFTPServer.html#z0_9">00227</a>   <span class="keywordtype">int</span> <a class="code" href="classBFTPServer.html#z0_9">getPortRangeStart</a>() { <span class="keywordflow">return</span> portRangeStart; }
00229   <span class="keywordtype">void</span> <a class="code" href="classBFTPServer.html#z0_10">setPortRangeEnd</a>(<span class="keywordtype">int</span> portRangeEnd);
<a name="l00231"></a><a class="code" href="classBFTPServer.html#z0_11">00231</a>   <span class="keywordtype">int</span> <a class="code" href="classBFTPServer.html#z0_11">getPortRangeEnd</a>() { <span class="keywordflow">return</span> portRangeEnd; }
00232 
<a name="l00234"></a><a class="code" href="classBFTPServer.html#z0_12">00234</a>   <span class="keywordtype">void</span> <a class="code" href="classBFTPServer.html#z0_12">setTransferBlockSize</a>(size_t size) { transferBlockSize = size; }
<a name="l00236"></a><a class="code" href="classBFTPServer.html#z0_13">00236</a>   size_t <a class="code" href="classBFTPServer.html#z0_13">getTransferBlockSize</a>() { <span class="keywordflow">return</span> transferBlockSize; }
00237   
00247   <span class="keyword">class </span>Delegate {
00248   <span class="keyword">public</span>:
00249     <span class="keyword">virtual</span> ~Delegate() {}
00251     <span class="keyword">virtual</span> <span class="keywordtype">bool</span> controlConnectionWillOpen(<a class="code" href="classBFTPServer.html">BFTPServer</a> *server,
00252                                            <span class="keywordtype">long</span> address) { <span class="keywordflow">return</span> <span class="keyword">true</span>; }
00253     <span class="keyword">virtual</span> <span class="keywordtype">void</span> controlConnectionDidOpen(<a class="code" href="classBFTPServer.html">BFTPServer</a> *server,
00254                                           <a class="code" href="classBFTPControlConn.html">BFTPControlConn</a> *conn) {}
00255   };
00256 
00257   <span class="keywordtype">void</span> setDelegate(Delegate* deleg);
00258   Delegate* delegate() { <span class="keywordflow">return</span> deleg; }
00259 
00264 
00265   <span class="keywordtype">void</span> <a class="code" href="classBFTPServer.html#a5">connectionDidClose</a>(<a class="code" href="classBFTPControlConn.html">BFTPControlConn</a>* conn);
00266 
<a name="l00268"></a><a class="code" href="classBFTPServer.html#a6">00268</a>   <span class="keywordtype">void</span> <a class="code" href="classBFTPServer.html#a6">setScreenSaverTimeout</a>(<span class="keywordtype">int</span> to) { ssTimeout = to; }
<a name="l00270"></a><a class="code" href="classBFTPServer.html#a7">00270</a>   <span class="keywordtype">int</span> <a class="code" href="classBFTPServer.html#a7">screenSaverTimeout</a>() { <span class="keywordflow">return</span> ssTimeout; }
00271 
00272 <span class="keyword">protected</span>:
00273   <span class="keyword">virtual</span> <span class="keywordtype">bool</span> <a class="code" href="classBFTPServer.html#b0">handleAccept</a>();
00274 
00275 <span class="keyword">private</span>:
00276   std::string motdFile;
00277   std::deque&lt;BFTPUser&gt; users;
00278   std::string masqueradeAsHost;
00279   <span class="keywordtype">int</span> inactivityTimeout;
00280   <span class="keywordtype">int</span> portRangeStart, portRangeEnd;
00281   size_t transferBlockSize;
00282   std::deque&lt;BFTPControlConn*&gt; connections;
00283   std::deque&lt;BFTPControlConn*&gt; connectionsToDelete;
00284   Delegate *deleg;
00285 
00286   <span class="keywordtype">int</span> ssTimeout;
00287 
00288 <span class="keyword">public</span>:
00289   <a class="code" href="structBFTPUser.html">BFTPUser</a> getUserWithName(<span class="keyword">const</span> std::string&amp; name);
00290   <span class="keywordtype">int</span> getNumberOfUsers() { <span class="keywordflow">return</span> users.size(); }
00291 };
00292 
<a name="l00299"></a><a class="code" href="classBFTPControlConn.html">00299</a> <span class="keyword">class </span><a class="code" href="classBFTPControlConn.html">BFTPControlConn</a>: <span class="keyword">public</span> <a class="code" href="classBTCPConnection.html">BTCPConnection</a> {
00300 <span class="keyword">protected</span>:
00301 
<a name="l00308"></a><a class="code" href="classBFTPControlConn_1_1BFTPDataConn.html">00308</a>   <span class="keyword">class </span><a class="code" href="classBFTPControlConn_1_1BFTPDataConn.html">BFTPDataConn</a>: <span class="keyword">public</span> <a class="code" href="classBTCPConnection.html">BTCPConnection</a> {
00309   <span class="keyword">public</span>:
00310     <a class="code" href="classBFTPControlConn_1_1BFTPDataConn.html">BFTPDataConn</a>(<span class="keywordtype">long</span> addr, <span class="keywordtype">short</span> port, <a class="code" href="classBFTPControlConn.html">BFTPControlConn</a>* master);
00311     <a class="code" href="classBFTPControlConn_1_1BFTPDataConn.html">BFTPDataConn</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* hostname, <span class="keywordtype">short</span> port, <a class="code" href="classBFTPControlConn.html">BFTPControlConn</a>* master);
00312     <a class="code" href="classBFTPControlConn_1_1BFTPDataConn.html">BFTPDataConn</a>(<span class="keywordtype">short</span> port, <a class="code" href="classBFTPControlConn.html">BFTPControlConn</a>* master);
00313     ~<a class="code" href="classBFTPControlConn_1_1BFTPDataConn.html">BFTPDataConn</a>();
00314     
00315     <span class="keyword">virtual</span> <span class="keywordtype">bool</span> <a class="code" href="classBFTPControlConn_1_1BFTPDataConn.html#a4">handleAccept</a>();
00316     <span class="keyword">virtual</span> <span class="keywordtype">bool</span> <a class="code" href="classBFTPControlConn_1_1BFTPDataConn.html#a5">handleConnection</a>();
00317     <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classBFTPControlConn_1_1BFTPDataConn.html#a6">close</a>();
00318     <span class="keywordtype">bool</span> jobDone() { <span class="keywordflow">return</span> jobdone; }
00319     <span class="keywordtype">int</span> finishCode() { <span class="keywordflow">return</span> fcode; }
00320     <span class="keyword">const</span> std::string&amp; finishMessage() { <span class="keywordflow">return</span> fdescr; }
00321 
00322     <span class="keyword">virtual</span> <span class="keywordtype">void</span> startStoring(BVirtualFile* file);
00323     <span class="keyword">virtual</span> <span class="keywordtype">void</span> startRetrieving(BVirtualFile* file);
00324     <span class="keyword">virtual</span> <span class="keywordtype">void</span> startSendingData(<span class="keyword">const</span> std::string&amp; data);
00325 
00326     <span class="keyword">virtual</span> <span class="keywordtype">bool</span> handleStore();
00327     <span class="keyword">virtual</span> <span class="keywordtype">bool</span> handleRetrieve();
00328     <span class="keyword">virtual</span> <span class="keywordtype">bool</span> handleSend();
00329 
00330     <span class="keyword">virtual</span> <span class="keywordtype">void</span> abort();
00331 
00332     <span class="keyword">typedef</span> <span class="keyword">enum</span> {
00333       DCMODE_IDLE,
00334       DCMODE_STORING,
00335       DCMODE_RETRIEVING,
00336       DCMODE_SENDINGDATA
00337     } DCMode;
00338 
00339   <span class="keyword">private</span>:
00340     <span class="keywordtype">void</span> finish(<span class="keywordtype">int</span> code, <span class="keyword">const</span> std::string&amp; descr);
00341     
00342     <a class="code" href="classBFTPControlConn.html">BFTPControlConn</a>* master;
00343 
00344     std::string data;
00345     BVirtualFile* file;
00346     DCMode mode;
00347 
00348     <span class="keywordtype">char</span> buf[8192];
00349     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> buflen, bufindex, total;
00350     <span class="keywordtype">bool</span> finished, remoteclosed, jobdone;
00351     <span class="keywordtype">int</span> fcode; std::string fdescr;
00352   };
00353 
00354 <span class="keyword">public</span>:
00355   <a class="code" href="classBFTPControlConn.html">BFTPControlConn</a>(<a class="code" href="classBFTPServer.html">BFTPServer</a>* master, <span class="keywordtype">int</span> conn,
00356                   <span class="keyword">const</span> <span class="keyword">struct</span> sockaddr_in&amp; lastaddr);
00357   <span class="keyword">virtual</span> ~<a class="code" href="classBFTPControlConn.html">BFTPControlConn</a>();
00358 
00359   std::string userInfo();
00360   <span class="keyword">const</span> <a class="code" href="structBFTPUser.html">BFTPUser</a>&amp; currentUser();
00361   
00362   <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classBFTPControlConn.html#a4">close</a>();
00363   <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classBFTPControlConn.html#a5">handle</a>();
00364 
00365   <span class="keywordtype">int</span> createDataConnection();
00366   <span class="keywordtype">void</span> destroyDataConnection();
00367   <span class="keywordtype">void</span> updateActivityTime();
00368   
00374   <span class="keyword">class </span>Delegate {
00375   <span class="keyword">public</span>:
00376     <span class="keyword">virtual</span> ~Delegate() {}
00377     <span class="keyword">virtual</span> <span class="keywordtype">void</span> controlConnectionWillClose(<a class="code" href="classBFTPControlConn.html">BFTPControlConn</a> *conn) {}
00378     <span class="keyword">virtual</span> <span class="keywordtype">void</span> controlConnectionDidClose(<a class="code" href="classBFTPControlConn.html">BFTPControlConn</a> *conn) {}
00379 
00381     <span class="keyword">virtual</span> <span class="keywordtype">void</span> activityOnControlConnection(<a class="code" href="classBFTPControlConn.html">BFTPControlConn</a> *conn) {}
00382 
00383     <span class="keyword">virtual</span> <span class="keywordtype">bool</span> handleUnknownCommand(<a class="code" href="classBFTPControlConn.html">BFTPControlConn</a> *cconn,
00384                                       std::string&amp; cmd, std::string&amp; arg)
00385     {
00386       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00387     }
00388       
00389   };
00390 
00391   <span class="keywordtype">void</span> setDelegate(Delegate* deleg) { this-&gt;deleg = deleg; }
00392   Delegate* delegate() { <span class="keywordflow">return</span> deleg; }
00393 
00398   <span class="keywordtype">bool</span> sendReply(<span class="keywordtype">int</span> code, <span class="keyword">const</span> <span class="keywordtype">char</span>* format, ...);
00399   <span class="keywordtype">bool</span> sendReply(<span class="keywordtype">int</span> code, <span class="keyword">const</span> std::string&amp; reply);
00400 
00402   std::string <a class="code" href="classBFTPControlConn.html#a11">makeAbsoluteFilename</a>(<span class="keyword">const</span> std::string&amp; fname);
00403 
00404   <a class="code" href="classBFTPServer.html">BFTPServer</a>* getMaster() { <span class="keywordflow">return</span> master; }
00405 
00406 <span class="keyword">protected</span>:
00407   <span class="keyword">virtual</span> <span class="keywordtype">bool</span> <a class="code" href="classBFTPControlConn.html#b0">handleInput</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* buf, <span class="keywordtype">int</span> buflen);
00408 
00409   <span class="keywordtype">bool</span> setLoginName(<span class="keyword">const</span> std::string&amp; name);
00410   <span class="keywordtype">bool</span> setLoginPassword(<span class="keyword">const</span> std::string&amp; pass);
00411   <span class="keywordtype">bool</span> setCurrentUserByName(<span class="keyword">const</span> std::string&amp; name);
00412 
00413   <span class="keywordtype">bool</span> changeWorkingDir(<span class="keyword">const</span> std::string&amp; newwd);
00414   <span class="keywordtype">bool</span> listDir(BFTPDataConn* dc, <span class="keyword">const</span> std::string&amp; args,
00415                <span class="keywordtype">bool</span> namesOnly = <span class="keyword">false</span>);
00416   <span class="keywordtype">bool</span> storeFile(BFTPDataConn* dc, <span class="keyword">const</span> std::string&amp; args);
00417   <span class="keywordtype">bool</span> retrieveFile(BFTPDataConn* dc, <span class="keyword">const</span> std::string&amp; args);
00418 
00419   <span class="keywordtype">void</span> closeIfInactive();
00420 
00421   BFTPDataConn* dc;
00422   <a class="code" href="classBFTPServer.html">BFTPServer</a>* master;
00423   Delegate *deleg;
00424 
00425   <span class="keywordtype">void</span> dcHandleAccept(BFTPDataConn* dc);
00426   <span class="keywordtype">void</span> dcReportFinish(BFTPDataConn* dc,
00427                       BFTPDataConn::DCMode mode,
00428                       <span class="keywordtype">bool</span> remoteclosed);
00429 
00430   std::string cwd, fullcwd;
00431   std::string lastcmd, lastarg;
00432   std::string renameFrom;
00433 
<a name="l00434"></a><a class="code" href="classBFTPControlConn.html#n8">00434</a>   <span class="keywordtype">char</span> <a class="code" href="classBFTPControlConn.html#n8">buf</a>[4096];
00435 
00436   <span class="keyword">typedef</span> <span class="keyword">enum</span> {
00437     TYPE_ASCII,
00438     TYPE_IMAGE
00439   } TransferType;
00440   TransferType ttype;
00441 
00442   <a class="code" href="structBFTPUser.html">BFTPUser</a> user;
00443 
00444   time_t lastActivityTime;
00445 };
00446 
00447 
00448 <span class="preprocessor">#endif </span><span class="comment">/* BFTPSERVER_H */</span>
</pre></div><hr><address style="align: right;"><small>Generated on Thu Feb 14 08:32:14 2008 for libDSFTP by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
